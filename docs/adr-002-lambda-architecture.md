# ADR-002: Lambda Architecture - Lambdalith vs Microservices

## ステータス
採用

## コンテキスト
### 背景
- TODOアプリケーションのバックエンドアーキテクチャをLambda上で構築
- 一人開発の学習プロジェクトという制約
- Honoフレームワークを使用してAPIを構築
- 管理コストを抑えつつ実践的なスキルを習得したい

### 要求事項
- **機能要件**: REST API（CRUD操作、認証、検索・フィルタ）
- **非機能要件**: 保守性、デプロイの簡単さ、コスト効率
- **制約条件**: 一人開発、学習目的、管理コストの最小化

## 検討した選択肢

### 選択肢1: マイクロサービス（関数分離）アプローチ
**メリット:**
- 関数ごとの最適化（メモリ、タイムアウト設定）
- きめ細かいIAM権限設定
- 独立したデプロイとスケーリング
- テストが容易
- AWS公式推奨のベストプラクティス

**デメリット:**
- 多数のLambda関数管理が必要
- デプロイ時間の増加
- コールドスタートの影響（低頻度アクセス時）
- インフラ設定の複雑化
- 一人開発では過剰なアーキテクチャ

**考慮事項:**
- 企業開発やチーム開発では推奨される
- 大規模システムでは管理メリットが大きい

### 選択肢2: Lambdalith（モノリシック Lambda）アプローチ
**メリット:**
- 単一Lambda関数で管理が簡単
- Honoアプリケーション全体を1つのエンドポイントで実行
- デプロイが簡単（1つの関数のみ）
- コード共有とコロケーション（関連コードを近くに配置）
- ローカル開発環境との一貫性
- 学習プロジェクトに適した規模

**デメリット:**
- パッケージサイズの増大
- 広範囲なIAM権限が必要
- 個別最適化が困難
- AWS公式ではアンチパターンとされている

**考慮事項:**
- 一人開発の学習プロジェクトでは実用的
- 適切なコード規律があれば管理可能

### 選択肢3: ハイブリッドアプローチ
**メリット:**
- 認証など独立性が重要な機能は分離
- 主要API群は単一Lambda関数で処理
- バランスの取れたアーキテクチャ

**デメリット:**
- 複雑性の増加
- 設計判断が多数必要
- 学習コストの増加

**考慮事項:**
- 実装コストと学習効果のバランスが微妙

## 決定
### 選択した解決策
**Lambdalith（モノリシック Lambda）アプローチ**を採用

### アーキテクチャ詳細
```
Single Lambda Function:
├── Hono Application (all routes)
├── Authentication middleware
├── CRUD operations
├── Business logic
└── DynamoDB integration

API Gateway → Single Lambda Function → DynamoDB
```

### 決定要因
1. **学習効率**: 一人開発の学習プロジェクトに適した規模感
2. **管理コスト**: 単一Lambda関数の簡単な管理
3. **Hono親和性**: フレームワークの特性を活かした自然なアーキテクチャ
4. **開発体験**: ローカル開発環境との一貫性
5. **デプロイ簡素化**: 単一エンドポイントでの簡単なデプロイ
6. **実用性**: TODOアプリの規模では十分実用的

### 設計制約とガイドライン
1. **コード規律**: モジュラー設計で保守性を確保
2. **パッケージサイズ**: 50MB以下を目標
3. **権限設計**: 最小権限の原則を適用
4. **モニタリング**: CloudWatchでパフォーマンス監視
5. **将来移行**: 必要に応じてマイクロサービス化への道筋を残す

## 結果
### 期待される効果
- **開発効率**: 単一コードベースでの迅速な開発
- **学習集中**: アーキテクチャ複雑性よりもビジネスロジックに集中
- **運用簡易**: 単一Lambda関数の簡単な監視・管理
- **コスト効率**: 関数数削減によるAWS料金最適化
- **デプロイ速度**: 単一関数の高速デプロイ

### 潜在的なリスク
- **パフォーマンス**: パッケージサイズ増大によるコールドスタート影響
- **セキュリティ**: 広範囲なIAM権限が必要
- **スケーラビリティ**: 将来的な機能拡張時の制約
- **ベストプラクティス**: AWS推奨に反するアーキテクチャ

### リスク軽減策
- **コード分割**: モジュラー設計で将来の分離を容易に
- **パッケージ最適化**: 必要最小限の依存関係
- **権限設計**: 可能な限り最小権限を適用
- **監視強化**: パフォーマンスメトリクスの詳細追跡
- **移行計画**: 必要時のマイクロサービス移行戦略を策定

### モニタリング指標
- **コールドスタート時間**: 目標3秒以下
- **パッケージサイズ**: 目標50MB以下
- **メモリ使用量**: 実行時メモリ効率
- **レスポンス時間**: API応答時間
- **エラー率**: Lambda実行エラー率

## 参考資料
- [AWS Blog: Comparing design approaches for building serverless microservices](https://aws.amazon.com/jp/blogs/news/comparing-design-approaches-for-building-serverless-microservices/)
- [AWS Lambda Developer Guide: Event-driven architectures](https://docs.aws.amazon.com/lambda/latest/dg/concepts-event-driven-architectures.html#monolith)
- [Should you use a Lambda monolith (Lambdalith) for the API?](https://rehanvdm.com/blog/should-you-use-a-lambda-monolith-lambdalith-for-the-api)
- [Serverless Patterns Collection](https://serverlessland.com/patterns)

## 将来の検討事項
- アプリケーション成長時のマイクロサービス移行タイミング
- パフォーマンス問題発生時の分離戦略
- 認証など独立性が重要な機能の分離検討